version: "3.9"

x-default-planargs-volumes: &default-planargs-volumes
  - type: bind
    source: /tmp/.X11-unix
    target: /tmp/.X11-unix
  - type: bind
    source: /etc/localtime
    target: /etc/localtime
    read_only: true
  # Xauthority
  - type: bind
    source: ${XAUTHORITY:-$HOME/.Xauthority}
    target: /root/.Xauthority
    read_only: true
  - type: bind
    source: ./
    target: /workspace
  # nvoptix is optional-ish on some hosts; keep if it exists in your environment
  - type: bind
    source: /usr/share/nvidia/nvoptix.bin
    target: /usr/share/nvidia/nvoptix.bin
    read_only: true
  - type: bind
    source: ./nvidia_icd_glx.json
    target: /etc/vulkan/icd.d/nvidia_icd_glx.json
    read_only: true

x-default-planargs-environment: &default-planargs-environment
  OMNI_KIT_ALLOW_ROOT: "1"
  TERM: ${TERM}
  DISPLAY: ${DISPLAY:-:20}
  QT_X11_NO_MITSHM: "1"
  XAUTHORITY: /root/.Xauthority
  XDG_RUNTIME_DIR: /tmp/runtime-root
  # NVIDIA container runtime
  NVIDIA_DRIVER_CAPABILITIES: compute,utility,graphics,display,video
  NVIDIA_VISIBLE_DEVICES: all
  __GLX_VENDOR_LIBRARY_NAME: nvidia
  # PlanarGS specific
  PLANARGS_PATH: ${PLANARGS_PATH:-/workspace}
  # Recommended (optional)
  VK_ICD_FILENAMES: /etc/vulkan/icd.d/nvidia_icd_glx.json
  TORCH_CUDA_ARCH_LIST: "7.0;7.5;8.0;8.6;8.9;9.0"

services:
  # noVNC Desktop (X server provider)
  desktop:
    image: ghcr.io/matsuolab/virtual_desktop:latest
    container_name: planargs_desktop
    # modern compose: prefer "gpus" over runtime=nvidia
    gpus:
      - count: all
        capabilities: [gpu]
    environment:
      <<: *default-planargs-environment
    ports:
      - "${WEB_PORT:-6080}:6080"
    volumes:
      - "/tmp/.X11-unix:/tmp/.X11-unix:rw"
    security_opt:
      - seccomp:unconfined
    shm_size: "2gb"
    ipc: host

  planargs:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PLANARGS_PATH_ARG: ${PLANARGS_PATH:-/workspace}
    image: planargs:latest
    container_name: planargs
    gpus:
      - count: all
        capabilities: [gpu]
    depends_on:
      - desktop
    shm_size: "16gb"
    ipc: host
    environment:
      <<: *default-planargs-environment
      # Force headless EGL to avoid GLX requirements in the container
      KIT_USE_EGL: "1"
    volumes: *default-planargs-volumes
    working_dir: /workspace
    network_mode: host
    entrypoint: ["bash"]
    stdin_open: true
    tty: true

  # Optional: dedicated headless service (no X, no swapchain)
  planargs_headless:
    image: planargs:latest
    container_name: planargs_headless
    gpus:
      - count: all
        capabilities: [gpu]
    environment:
      <<: *default-planargs-environment
      DISPLAY: ""  # no X
      KIT_USE_EGL: "1"
    shm_size: "16gb"
    ipc: host
    volumes: *default-planargs-volumes
    working_dir: /workspace
    network_mode: host
    entrypoint: ["bash"]
    stdin_open: true
    tty: true
    profiles: ["headless"]
