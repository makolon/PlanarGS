version: "3.9"

x-default-planargs-volumes: &default-planargs-volumes
  - type: bind
    source: /tmp/.X11-unix
    target: /tmp/.X11-unix
  - type: bind
    source: /etc/localtime
    target: /etc/localtime
    read_only: true
  # Xauthority
  - type: bind
    source: ${XAUTHORITY:-$HOME/.Xauthority}
    target: /root/.Xauthority
    read_only: true
  - type: bind
    source: ./
    target: /workspace

x-default-planargs-environment: &default-planargs-environment
  # NVIDIA container runtime
  NVIDIA_DRIVER_CAPABILITIES: all
  NVIDIA_VISIBLE_DEVICES: all
  # PlanarGS specific
  PLANARGS_PATH: ${PLANARGS_PATH:-/workspace}
  # Recommended
  TORCH_CUDA_ARCH_LIST: "7.0;7.5;8.0;8.6;8.9;9.0"

services:
  planargs:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PLANARGS_PATH_ARG: ${PLANARGS_PATH:-/workspace}
    image: planargs:latest
    container_name: planargs
    gpus:
      - count: all
        capabilities: [gpu]
    shm_size: "16gb"
    ipc: host
    environment:
      <<: *default-planargs-environment
      # Force headless EGL to avoid GLX requirements in the container
      KIT_USE_EGL: "1"
    volumes: *default-planargs-volumes
    working_dir: /workspace
    network_mode: host
    entrypoint: ["bash"]
    stdin_open: true
    tty: true
